<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dota 2 Pick Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .search { margin: 10px; padding: 5px; width: 80%; }
        .heroes { display: flex; flex-wrap: wrap; justify-content: center; }
        .hero { margin: 5px; padding: 10px; cursor: pointer; text-align: center; }
        .hero img { width: 50px; height: 50px; display: block; margin: auto; }
        .selected-heroes, .recommended-heroes { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .selected-hero, .recommended-hero { margin: 5px; text-align: center; }
        .selected-hero img, .recommended-hero img { width: 60px; height: 60px; border-radius: 10px; }
        .counterpicks { margin-top: 20px; font-weight: bold; color: green; }
    </style>
</head>
<body>
    <h2>Dota 2 Pick Assistant</h2>
    <input type="text" class="search" placeholder="Search hero..." oninput="filterHeroes()">
    <h3>Enemy Team:</h3>
    <div class="selected-heroes" id="selectedHeroes"></div>
    <h3>Available Heroes:</h3>
    <div class="heroes" id="heroList"></div>
    <h3>Recommended Picks:</h3>
    <div class="recommended-heroes" id="recommendedHeroes"></div>

    <script>
let allHeroes = [];
let selectedHeroes = [];
let counterpicks = {};
const imgBaseUrl = "https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota_react/heroes/";

async function fetchHeroes() {
    const cachedHeroes = localStorage.getItem("allHeroes");
    
    if (cachedHeroes) {
        allHeroes = JSON.parse(cachedHeroes);
        console.log("Loaded heroes from cache:", allHeroes);
        renderHeroes();
    } else {
        try {
            const response = await fetch("https://api.opendota.com/api/heroes");
            const data = await response.json();
            
            if (Array.isArray(data)) {
                allHeroes = data;
                localStorage.setItem("allHeroes", JSON.stringify(allHeroes));
                console.log("Fetched heroes from API:", allHeroes);
                renderHeroes();
            } else {
                console.error("Expected an array of heroes, but got:", data);
            }
        } catch (error) {
            console.error("Error fetching heroes:", error);
        }
    }
}

async function fetchCounterpicksForSelectedHeroes() {
    try {
        counterpicks = {}; 
        for (const hero of selectedHeroes) {
            const response = await fetch(`https://api.opendota.com/api/heroes/${hero.id}/matchups`);
            const matchups = await response.json();

            counterpicks[hero.localized_name] = matchups
                .filter(matchup => matchup.games_played > 10)
                .sort((a, b) => (b.wins / b.games_played) - (a.wins / a.games_played))
                .slice(0, 5) 
                .map(matchup => {
                    const counterHero = allHeroes.find(h => h.id === matchup.hero_id);
                    return {
                        name: counterHero ? counterHero.localized_name : null,
                        winrate: ((matchup.wins / matchup.games_played) * 100).toFixed(2) + "%" 
                    };
                })
                .filter(counter => counter.name !== null);
            
            console.log(`Counterpicks for ${hero.localized_name}:`, counterpicks[hero.localized_name]); 
        }
        updateRecommendedHeroes();
    } catch (error) {
        console.error("Error fetching counterpicks:", error);
    }
}

function renderHeroes() {
    const heroList = document.getElementById("heroList");
    heroList.innerHTML = "";
    
    if (Array.isArray(allHeroes)) {
        allHeroes.forEach(hero => {
            let div = document.createElement("div");
            div.className = "hero";
            div.innerHTML = `<img src='${imgBaseUrl + hero.name.replace("npc_dota_hero_", "")}.png' alt='${hero.localized_name}'><br>${hero.localized_name}`;
            div.onclick = () => selectHero(hero);
            heroList.appendChild(div);
        });
    } else {
        console.error("allHeroes is not an array:", allHeroes);
    }
}

function selectHero(hero) {
    if (selectedHeroes.length < 5 && !selectedHeroes.some(h => h.id === hero.id)) {
        selectedHeroes.push(hero);
        updateSelectedHeroes();
        fetchCounterpicksForSelectedHeroes(); // Загружаем контрпики только для выбранных героев
    }
}

function updateSelectedHeroes() {
    const selectedDiv = document.getElementById("selectedHeroes");
    selectedDiv.innerHTML = "";

    if (selectedHeroes.length > 0) {
        let clearButton = document.createElement("button");
        clearButton.innerText = "Очистить всё";
        clearButton.onclick = clearSelectedHeroes;
        clearButton.style.margin = "10px";
        clearButton.style.padding = "5px 10px";
        clearButton.style.cursor = "pointer";
        selectedDiv.appendChild(clearButton);
    }

    selectedHeroes.forEach(hero => {
        let div = document.createElement("div");
        div.className = "selected-hero";
        div.innerHTML = `<img src='${imgBaseUrl + hero.name.replace("npc_dota_hero_", "")}.png' alt='${hero.localized_name}'><br>${hero.localized_name}`;
        div.onclick = () => removeSelectedHero(hero); // Удаляем героя по клику
        selectedDiv.appendChild(div);
    });
}

function clearSelectedHeroes() {
    selectedHeroes = [];
    counterpicks = {};
    updateSelectedHeroes();
    updateRecommendedHeroes();
}

function removeSelectedHero(hero) {
    selectedHeroes = selectedHeroes.filter(h => h.id !== hero.id);
    delete counterpicks[hero.localized_name]; // Удаляем контрпики для этого героя
    updateSelectedHeroes();
    updateRecommendedHeroes();
}

function updateRecommendedHeroes() {
    let recommendedSet = new Set();
    selectedHeroes.forEach(hero => {
        if (counterpicks[hero.localized_name]) {
            counterpicks[hero.localized_name].forEach(counter => {
                recommendedSet.add({
                    name: counter.name,
                    winrate: counter.winrate
                });
            });
        }
    });

    const recommendedDiv = document.getElementById("recommendedHeroes");
    recommendedDiv.innerHTML = "";

    console.log("Recommended heroes:", Array.from(recommendedSet)); // Проверка данных

    Array.from(recommendedSet).forEach(counter => {
        let hero = allHeroes.find(h => h.localized_name === counter.name);
        if (hero) {
            let div = document.createElement("div");
            div.className = "recommended-hero";
            div.innerHTML = `
                <img src='${imgBaseUrl + hero.name.replace("npc_dota_hero_", "")}.png' alt='${hero.localized_name}'>
                <br>${hero.localized_name}
                <br><small>Winrate: ${counter.winrate}</small>
            `;
            recommendedDiv.appendChild(div);
        }
    });
}

function filterHeroes() {
    let search = document.querySelector(".search").value.toLowerCase();
    document.querySelectorAll(".hero").forEach(heroDiv => {
        heroDiv.style.display = heroDiv.textContent.toLowerCase().includes(search) ? "block" : "none";
    });
}

fetchHeroes();
    </script>
</body>
</html>
